<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#D71920">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Lanxess Safety AR Pro - COMPLETO</title>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Exo+2:wght@400;700&family=Roboto:wght@400;700&display=swap');
        
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; user-select:none; }
        html, body { width:100%; height:100%; position:fixed; overflow:hidden; background:#0a0a0a; font-family:'Roboto',sans-serif; color:#fff; }
        
        .view { position:absolute; top:0; left:0; width:100%; height:100%; display:none; opacity:0; transition:opacity 0.6s; z-index:1; }
        .view.active { display:flex; opacity:1; z-index:10; }
        
        .btn-back { position:fixed; top:calc(env(safe-area-inset-top,20px) + 10px); left:15px; width:52px; height:52px; background:rgba(10,10,10,0.95); backdrop-filter:blur(15px); border:2px solid rgba(255,255,255,0.3); border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:99999; transition:all 0.2s; box-shadow:0 4px 20px rgba(0,0,0,0.8); pointer-events:auto; }
        .btn-back::before { content:'‚Üê'; font-size:26px; font-weight:900; color:#fff; }
        .btn-back:active { transform:scale(0.88); background:#D71920; border-color:#D71920; }
        
        #home { flex-direction:column; justify-content:center; align-items:center; background:linear-gradient(135deg,#1a1a1a 0%,#000 100%); padding:40px 20px; }
        .home-header { text-align:center; margin-bottom:60px; animation:fadeInDown 1s ease-out; }
        @keyframes fadeInDown { from{opacity:0;transform:translateY(-30px)} to{opacity:1;transform:translateY(0)} }
        .logo-icon { font-size:64px; filter:drop-shadow(0 0 25px rgba(215,25,32,0.6)); animation:pulse 2.5s infinite; margin-bottom:25px; }
        @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
        .home-header h1 { font-family:'Orbitron',monospace; font-size:38px; font-weight:900; text-transform:uppercase; letter-spacing:3px; background:linear-gradient(135deg,#fff 0%,#b0b0b0 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:12px; }
        .accent-line { width:70px; height:4px; background:#D71920; margin:12px auto; border-radius:2px; box-shadow:0 0 15px rgba(215,25,32,0.7); }
        .home-header p { font-family:'Exo 2',sans-serif; font-size:13px; letter-spacing:2.5px; color:#b0b0b0; text-transform:uppercase; }
        .menu-grid { display:flex; flex-direction:column; gap:18px; width:100%; max-width:380px; animation:fadeInUp 1s ease-out 0.3s both; }
        @keyframes fadeInUp { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }
        .menu-item { background:rgba(255,255,255,0.04); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.12); border-left:4px solid #D71920; border-radius:14px; padding:24px 20px; cursor:pointer; position:relative; overflow:hidden; transition:all 0.4s; display:flex; align-items:center; gap:18px; }
        .menu-item::before { content:''; position:absolute; top:0; left:0; width:0; height:100%; background:linear-gradient(90deg,rgba(215,25,32,0.15) 0%,transparent 100%); transition:width 0.4s; }
        .menu-item:active { transform:scale(0.97); background:rgba(255,255,255,0.08); }
        .menu-item:active::before { width:100%; }
        .menu-icon { font-size:36px; min-width:36px; filter:drop-shadow(0 0 8px rgba(255,255,255,0.3)); }
        .menu-content h3 { font-family:'Exo 2',sans-serif; font-size:20px; font-weight:700; margin-bottom:5px; color:#fff; }
        .menu-content p { font-size:12px; color:#b0b0b0; line-height:1.4; }
        .menu-arrow { margin-left:auto; font-size:22px; color:#D71920; font-weight:900; }
        .home-footer { position:absolute; bottom:calc(env(safe-area-inset-bottom,20px) + 20px); left:0; width:100%; text-align:center; font-family:'Orbitron',monospace; font-size:9px; color:#444; letter-spacing:2px; }
        
        #meter { flex-direction:column; align-items:center; justify-content:flex-start; background:linear-gradient(180deg,#000 0%,#1a1a1a 100%); padding-top:calc(env(safe-area-inset-top,20px) + 90px); }
        .meter-display { width:280px; height:280px; position:relative; margin-bottom:40px; }
        .meter-circle { width:100%; height:100%; border-radius:50%; background:radial-gradient(circle,rgba(26,26,26,0.9) 0%,rgba(10,10,10,1) 100%); border:5px solid #2a2a2a; box-shadow:0 0 50px rgba(0,0,0,0.9),inset 0 0 50px rgba(0,0,0,0.6); display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; transition:all 0.4s; }
        .meter-circle::before { content:''; position:absolute; top:-8px; left:-8px; right:-8px; bottom:-8px; border-radius:50%; background:conic-gradient(from 0deg,transparent 0%,#D71920 50%,transparent 100%); opacity:0; transition:opacity 0.4s; z-index:-1; animation:rotate 3s linear infinite; }
        @keyframes rotate { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
        .meter-circle.danger::before { opacity:0.7; }
        .db-value { font-family:'Orbitron',monospace; font-size:76px; font-weight:900; color:#fff; text-shadow:0 0 25px rgba(255,255,255,0.6); line-height:1; margin-bottom:5px; }
        .db-unit { font-family:'Exo 2',sans-serif; font-size:16px; color:#b0b0b0; letter-spacing:2px; }
        .status-indicator { margin-top:20px; padding:9px 20px; background:rgba(255,255,255,0.06); border-radius:25px; border:1px solid rgba(255,255,255,0.12); font-family:'Exo 2',sans-serif; font-size:12px; font-weight:700; letter-spacing:2px; text-transform:uppercase; transition:all 0.2s; }
        .wave-visualizer { width:90%; max-width:360px; height:100px; position:relative; margin-top:30px; background:rgba(255,255,255,0.02); border-radius:10px; border:1px solid rgba(255,255,255,0.06); overflow:hidden; }
        #waveCanvas { width:100%; height:100%; }
        .meter-info { max-width:320px; padding:20px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.1); border-radius:10px; margin-top:25px; text-align:center; }
        .meter-info p { font-size:13px; line-height:1.6; color:#b0b0b0; }
        .meter-info .highlight { color:#D71920; font-weight:700; }
        
        #ar { background:transparent !important; pointer-events:none; }
        .ar-hud { position:fixed; top:calc(env(safe-area-inset-top,20px) + 70px); right:15px; pointer-events:none; z-index:1000; }
        .hud-meter { background:rgba(0,0,0,0.85); backdrop-filter:blur(20px); border:2px solid rgba(255,255,255,0.25); border-right:4px solid #D71920; border-radius:8px; padding:12px 16px; min-width:120px; box-shadow:0 6px 25px rgba(0,0,0,0.7); }
        .hud-label { font-family:'Exo 2',sans-serif; font-size:9px; color:#b0b0b0; letter-spacing:1.5px; text-transform:uppercase; margin-bottom:6px; }
        .hud-value { font-family:'Orbitron',monospace; font-size:28px; font-weight:900; color:#D71920; text-shadow:0 0 18px rgba(215,25,32,0.7); line-height:1; text-align:right; }
        .hud-bar { width:100%; height:4px; background:rgba(255,255,255,0.15); border-radius:2px; margin-top:8px; overflow:hidden; }
        .hud-fill { height:100%; width:0%; background:linear-gradient(90deg,#D71920 0%,#ff6b6b 100%); border-radius:2px; transition:width 0.2s ease-out; box-shadow:0 0 8px rgba(215,25,32,0.9); }
        .ar-controls { position:fixed; bottom:0; left:0; width:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(10px); padding:25px 20px calc(env(safe-area-inset-bottom,20px) + 20px); display:flex; flex-direction:column; align-items:center; gap:12px; pointer-events:auto; z-index:1000; }
        .ar-status-text { font-family:'Exo 2',sans-serif; font-size:15px; font-weight:600; color:#fff; text-align:center; margin-bottom:8px; text-shadow:0 2px 8px rgba(0,0,0,0.9); min-height:22px; }
        .btn-ar { width:100%; max-width:340px; padding:18px 28px; background:#fff; color:#0a0a0a; border:none; border-radius:50px; font-family:'Exo 2',sans-serif; font-size:15px; font-weight:900; text-transform:uppercase; letter-spacing:1px; cursor:pointer; position:relative; overflow:hidden; box-shadow:0 6px 25px rgba(255,255,255,0.25); transition:all 0.2s; display:none; }
        .btn-ar.visible { display:block; }
        .btn-ar:active { transform:scale(0.96); }
        #btnStartAR { background:#D71920; color:#fff; box-shadow:0 6px 25px rgba(215,25,32,0.5); }
        .danger-overlay { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:800; display:none; animation:dangerPulse 1.5s infinite; }
        .danger-overlay.active { display:block; }
        @keyframes dangerPulse { 0%,100%{box-shadow:inset 0 0 0 rgba(215,25,32,0)} 50%{box-shadow:inset 0 0 100px rgba(215,25,32,0.5)} }
        .loading-spinner { display:inline-block; width:16px; height:16px; border:3px solid rgba(255,255,255,0.3); border-top-color:#fff; border-radius:50%; animation:spin 0.7s linear infinite; margin-right:8px; vertical-align:middle; }
        @keyframes spin { to{transform:rotate(360deg)} }
        
        #arScene { position:fixed !important; top:0 !important; left:0 !important; width:100% !important; height:100% !important; z-index:5 !important; }
        .a-enter-vr, .a-orientation-modal { display:none !important; }
        a-scene { background:transparent !important; }
    </style>
</head>
<body>

    <div id="dangerOverlay" class="danger-overlay"></div>

    <div id="home" class="view active">
        <div class="home-header">
            <div class="logo-icon">üéß</div>
            <h1>Safety Suite</h1>
            <div class="accent-line"></div>
            <p>Protecci√≥n Auditiva</p>
        </div>
        <div class="menu-grid">
            <div class="menu-item" data-nav="meter">
                <div class="menu-icon">üéôÔ∏è</div>
                <div class="menu-content">
                    <h3>Medidor Ambiental</h3>
                    <p>An√°lisis de decibelios en tiempo real</p>
                </div>
                <div class="menu-arrow">‚Üí</div>
            </div>
            <div class="menu-item" data-nav="ar">
                <div class="menu-icon">ü•Ω</div>
                <div class="menu-content">
                    <h3>Simulaci√≥n AR</h3>
                    <p>Experiencia inmersiva de protecci√≥n</p>
                </div>
                <div class="menu-arrow">‚Üí</div>
            </div>
        </div>
        <div class="home-footer">LANXESS AR ‚Ä¢ v18.0 PRO FINAL</div>
    </div>

    <div id="meter" class="view">
        <div class="btn-back" data-nav="home"></div>
        <div class="meter-display">
            <div class="meter-circle" id="meterCircle">
                <div class="db-value" id="dbValue">--</div>
                <div class="db-unit">dB SPL</div>
                <div class="status-indicator" id="statusIndicator">INICIANDO</div>
            </div>
        </div>
        <div class="wave-visualizer"><canvas id="waveCanvas"></canvas></div>
        <div class="meter-info">
            <p>El micr√≥fono analiza el ruido ambiente en tiempo real. Cuando el medidor se torna <span class="highlight">ROJO</span>, el nivel de decibelios es perjudicial para tu audici√≥n.</p>
        </div>
    </div>

    <div id="ar" class="view">
        <div class="btn-back" data-nav="home"></div>
        <div class="ar-hud">
            <div class="hud-meter">
                <div class="hud-label">NIVEL RUIDO</div>
                <div class="hud-value" id="hudValue">0 dB</div>
                <div class="hud-bar"><div class="hud-fill" id="hudFill"></div></div>
            </div>
        </div>
        <div class="ar-controls">
            <div class="ar-status-text" id="arStatusText">Apunta la c√°mara al suelo para ver la escena</div>
            <button id="btnStartAR" class="btn-ar visible">üé¨ INICIAR ANIMACI√ìN</button>
        </div>
    </div>

    <a-scene id="arScene" vr-mode-ui="enabled:false" renderer="antialias:true;alpha:true" loading-screen="enabled:false" embedded style="display:none">
        <a-camera id="mainCamera" position="0 1.6 0" look-controls="enabled:true;magicWindowTrackingEnabled:true;touchEnabled:false;mouseEnabled:false" wasd-controls="enabled:false"></a-camera>
        
        <a-entity light="type:ambient;color:#FFF;intensity:0.6"></a-entity>
        <a-entity light="type:directional;color:#FFF;intensity:1.2" position="3 6 2"></a-entity>
        <a-entity light="type:point;color:#FFF;intensity:0.9;distance:8" position="0 3 0"></a-entity>
        <a-entity id="dangerLight" light="type:point;color:#D71920;intensity:0;distance:10" position="0 1.5 -2.5"></a-entity>
        
        <a-plane position="0 0 -2.5" rotation="-90 0 0" width="12" height="12" color="#222" material="roughness:0.95"></a-plane>
        
        <a-entity id="mainScene" position="0 0 -2.5">
            
            <a-entity id="tableGroup" position="1.3 0 0">
                <a-box width="0.85" height="0.05" depth="0.55" position="0 0.72 0" color="#8B4513" material="roughness:0.7"></a-box>
                <a-cylinder radius="0.028" height="0.72" color="#5a3a1a" position="-0.345 0.36 -0.2"></a-cylinder>
                <a-cylinder radius="0.028" height="0.72" color="#5a3a1a" position="0.345 0.36 -0.2"></a-cylinder>
                <a-cylinder radius="0.028" height="0.72" color="#5a3a1a" position="-0.345 0.36 0.2"></a-cylinder>
                <a-cylinder radius="0.028" height="0.72" color="#5a3a1a" position="0.345 0.36 0.2"></a-cylinder>
            </a-entity>

            <a-entity id="headphonesGroup" position="1.3 0.8 0">
                <a-entity id="headband">
                    <a-torus radius="0.13" radius-tubular="0.014" color="#1a1a1a" arc="185" material="metalness:0.85;roughness:0.25"></a-torus>
                </a-entity>
                <a-entity id="leftEarcup" position="-0.13 -0.055 0">
                    <a-cylinder radius="0.053" height="0.028" color="#0a0a0a" rotation="90 0 0" material="metalness:0.7;roughness:0.35"></a-cylinder>
                    <a-circle radius="0.024" color="#D71920" position="0 0 0.03" material="emissive:#D71920;emissiveIntensity:0.5"></a-circle>
                    <a-text value="L" color="#FFF" align="center" width="0.16" position="0 0 0.032" scale="0.65 0.65 0.65"></a-text>
                </a-entity>
                <a-entity id="rightEarcup" position="0.13 -0.055 0">
                    <a-cylinder radius="0.053" height="0.028" color="#0a0a0a" rotation="90 0 0" material="metalness:0.7;roughness:0.35"></a-cylinder>
                    <a-circle radius="0.024" color="#D71920" position="0 0 0.03" material="emissive:#D71920;emissiveIntensity:0.5"></a-circle>
                    <a-text value="R" color="#FFF" align="center" width="0.16" position="0 0 0.032" scale="0.65 0.65 0.65"></a-text>
                </a-entity>
            </a-entity>

            <a-entity id="stickmanRoot" position="0 0 0">
                <a-entity id="pelvis" position="0 0.14 0">
                    <a-sphere radius="0.032" color="#FFE0BD"></a-sphere>
                    <a-entity id="spine" position="0 0.26 0">
                        <a-cylinder radius="0.022" height="0.47" color="#4A90E2"></a-cylinder>
                        <a-entity id="neck" position="0 0.27 0">
                            <a-cylinder radius="0.019" height="0.065" color="#FFE0BD"></a-cylinder>
                            <a-entity id="head" position="0 0.105 0">
                                <a-sphere radius="0.095" color="#FFE0BD"></a-sphere>
                                <a-sphere radius="0.013" color="#000" position="-0.032 0.022 0.089"></a-sphere>
                                <a-sphere radius="0.013" color="#000" position="0.032 0.022 0.089"></a-sphere>
                                <a-sphere radius="0.007" color="#4A90E2" position="-0.032 0.022 0.097"></a-sphere>
                                <a-sphere radius="0.007" color="#4A90E2" position="0.032 0.022 0.097"></a-sphere>
                                <a-entity id="mouth" position="0 -0.022 0.089">
                                    <a-torus id="mouthShape" radius="0.027" radius-tubular="0.006" color="#000" arc="180"></a-torus>
                                </a-entity>
                                <a-sphere radius="0.009" color="#FFDBAC" position="0 0.006 0.096"></a-sphere>
                            </a-entity>
                        </a-entity>
                        <a-entity id="shoulders" position="0 0.23 0">
                            <a-box width="0.21" height="0.032" depth="0.055" color="#4A90E2"></a-box>
                            <a-entity id="leftShoulder" position="-0.105 0 0">
                                <a-sphere radius="0.021" color="#FFE0BD"></a-sphere>
                                <a-entity id="leftUpperArm" rotation="0 0 12">
                                    <a-cylinder radius="0.016" height="0.19" color="#4A90E2" position="0 -0.095 0"></a-cylinder>
                                    <a-entity id="leftElbow" position="0 -0.19 0">
                                        <a-sphere radius="0.019" color="#FFE0BD"></a-sphere>
                                        <a-entity id="leftForearm" rotation="0 0 3">
                                            <a-cylinder radius="0.013" height="0.17" color="#FFE0BD" position="0 -0.085 0"></a-cylinder>
                                            <a-entity id="leftHand" position="0 -0.17 0">
                                                <a-sphere radius="0.022" color="#FFE0BD"></a-sphere>
                                            </a-entity>
                                        </a-entity>
                                    </a-entity>
                                </a-entity>
                            </a-entity>
                            <a-entity id="rightShoulder" position="0.105 0 0">
                                <a-sphere radius="0.021" color="#FFE0BD"></a-sphere>
                                <a-entity id="rightUpperArm" rotation="0 0 -12">
                                    <a-cylinder radius="0.016" height="0.19" color="#4A90E2" position="0 -0.095 0"></a-cylinder>
                                    <a-entity id="rightElbow" position="0 -0.19 0">
                                        <a-sphere radius="0.019" color="#FFE0BD"></a-sphere>
                                        <a-entity id="rightForearm" rotation="0 0 -3">
                                            <a-cylinder radius="0.013" height="0.17" color="#FFE0BD" position="0 -0.085 0"></a-cylinder>
                                            <a-entity id="rightHand" position="0 -0.17 0">
                                                <a-sphere radius="0.022" color="#FFE0BD"></a-sphere>
                                            </a-entity>
                                        </a-entity>
                                    </a-entity>
                                </a-entity>
                            </a-entity>
                        </a-entity>
                    </a-entity>
                    <a-entity id="leftHip" position="-0.042 -0.024 0">
                        <a-sphere radius="0.027" color="#FFE0BD"></a-sphere>
                        <a-entity id="leftThigh" rotation="0 0 2">
                            <a-cylinder radius="0.021" height="0.25" color="#2C3E50" position="0 -0.125 0"></a-cylinder>
                            <a-entity id="leftKnee" position="0 -0.25 0">
                                <a-sphere radius="0.023" color="#FFE0BD"></a-sphere>
                                <a-entity id="leftCalf" rotation="0 0 -1">
                                    <a-cylinder radius="0.017" height="0.25" color="#2C3E50" position="0 -0.125 0"></a-cylinder>
                                    <a-entity id="leftAnkle" position="0 -0.25 0">
                                        <a-sphere radius="0.019" color="#FFE0BD"></a-sphere>
                                        <a-entity id="leftFoot" position="0 -0.022 0.024">
                                            <a-box width="0.053" height="0.016" depth="0.095" color="#0a0a0a" position="0 -0.008 0"></a-box>
                                        </a-entity>
                                    </a-entity>
                                </a-entity>
                            </a-entity>
                        </a-entity>
                    </a-entity>
                    <a-entity id="rightHip" position="0.042 -0.024 0">
                        <a-sphere radius="0.027" color="#FFE0BD"></a-sphere>
                        <a-entity id="rightThigh" rotation="0 0 -2">
                            <a-cylinder radius="0.021" height="0.25" color="#2C3E50" position="0 -0.125 0"></a-cylinder>
                            <a-entity id="rightKnee" position="0 -0.25 0">
                                <a-sphere radius="0.023" color="#FFE0BD"></a-sphere>
                                <a-entity id="rightCalf" rotation="0 0 1">
                                    <a-cylinder radius="0.017" height="0.25" color="#2C3E50" position="0 -0.125 0"></a-cylinder>
                                    <a-entity id="rightAnkle" position="0 -0.25 0">
                                        <a-sphere radius="0.019" color="#FFE0BD"></a-sphere>
                                        <a-entity id="rightFoot" position="0 -0.022 0.024">
                                            <a-box width="0.053" height="0.016" depth="0.095" color="#0a0a0a" position="0 -0.008 0"></a-box>
                                        </a-entity>
                                    </a-entity>
                                </a-entity>
                            </a-entity>
                        </a-entity>
                    </a-entity>
                </a-entity>
            </a-entity>

            <a-entity id="soundWaves" position="0 0.65 0" visible="false">
                <a-torus radius="0.35" radius-tubular="0.035" color="#FF0000" opacity="0.75" rotation="90 0 0"></a-torus>
            </a-entity>

            <a-entity id="infoPanel" position="0 1.3 0" visible="false">
                <a-plane width="1.8" height="0.6" color="#000" opacity="0.95"></a-plane>
                <a-plane width="1.75" height="0.55" color="#D71920" position="0 0 0.003"></a-plane>
                <a-plane width="1.7" height="0.5" color="#000" opacity="0.95" position="0 0 0.006"></a-plane>
                <a-text id="infoTitle" value="‚ö†Ô∏è 105 dB - PELIGRO ‚ö†Ô∏è" color="#FFFF00" align="center" width="2" position="0 0.15 0.01"></a-text>
                <a-text id="infoSubtitle" value="Exposici√≥n prolongada causa da√±o permanente" color="#FFF" align="center" width="1.9" position="0 -0.1 0.01"></a-text>
            </a-entity>

        </a-entity>
    </a-scene>

    <script>
const CFG = { audioFile: 'Sonidos_De_Fabrica.wav', dbThresholds: { safe: 60, warning: 85, danger: 95 } };

const Router = {
    cur: 'home',
    init() {
        document.querySelectorAll('[data-nav]').forEach(el => el.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();
            this.nav(e.currentTarget.getAttribute('data-nav'));
        }));
    },
    nav(id) {
        if (this.cur === id) return;
        const c = document.getElementById(this.cur);
        if (c) c.classList.remove('active');
        setTimeout(() => {
            const t = document.getElementById(id);
            if (t) t.classList.add('active');
            this.logic(id);
        }, 100);
        this.cur = id;
    },
    logic(id) {
        if (id === 'home') { Meter.stop(); AR.destroy(); }
        else if (id === 'meter') { AR.destroy(); setTimeout(() => Meter.start(), 200); }
        else if (id === 'ar') { Meter.stop(); setTimeout(() => AR.init(), 300); }
    }
};

const Meter = {
    active: false,
    stream: null,
    ctx: null,
    analyser: null,
    data: null,
    canvas: null,
    cctx: null,
    aid: null,
    async start() {
        if (this.active) return;
        try {
            this.stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } });
            const AC = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AC();
            this.analyser = this.ctx.createAnalyser();
            this.analyser.fftSize = 2048;
            this.analyser.smoothingTimeConstant = 0.8;
            const src = this.ctx.createMediaStreamSource(this.stream);
            src.connect(this.analyser);
            this.data = new Uint8Array(this.analyser.frequencyBinCount);
            this.canvas = document.getElementById('waveCanvas');
            this.cctx = this.canvas.getContext('2d');
            this.canvas.width = this.canvas.offsetWidth * window.devicePixelRatio;
            this.canvas.height = this.canvas.offsetHeight * window.devicePixelRatio;
            this.cctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            this.active = true;
            this.draw();
        } catch (e) {
            console.error('Mic:', e);
            alert('‚ùå Permite acceso al micr√≥fono');
            Router.nav('home');
        }
    },
    stop() {
        if (!this.active) return;
        if (this.aid) { cancelAnimationFrame(this.aid); this.aid = null; }
        if (this.stream) { this.stream.getTracks().forEach(t => t.stop()); this.stream = null; }
        if (this.ctx) { this.ctx.close(); this.ctx = null; }
        this.active = false;
    },
    draw() {
        if (!this.active) return;
        this.aid = requestAnimationFrame(() => this.draw());
        this.analyser.getByteFrequencyData(this.data);
        const avg = this.data.reduce((a, b) => a + b, 0) / this.data.length;
        let db = Math.floor(20 + avg * 0.9);
        db = Math.max(30, Math.min(120, db));
        this.updateUI(db);
        this.drawWave();
    },
    updateUI(db) {
        const v = document.getElementById('dbValue');
        const c = document.getElementById('meterCircle');
        const b = document.getElementById('statusIndicator');
        v.textContent = db;
        c.classList.remove('danger');
        if (db < CFG.dbThresholds.safe) {
            c.style.borderColor = '#34c759';
            b.style.background = '#34c759';
            b.style.color = '#000';
            b.textContent = '‚úì SEGURO';
        } else if (db < CFG.dbThresholds.danger) {
            c.style.borderColor = '#ffcc00';
            b.style.background = '#ffcc00';
            b.style.color = '#000';
            b.textContent = '‚ö† ALERTA';
        } else {
            c.style.borderColor = '#ff3b30';
            c.classList.add('danger');
            b.style.background = '#ff3b30';
            b.style.color = '#fff';
            b.textContent = '‚úñ PELIGRO';
        }
    },
    drawWave() {
        if (!this.cctx) return;
        const ctx = this.cctx;
        const w = this.canvas.width / window.devicePixelRatio;
        const h = this.canvas.height / window.devicePixelRatio;
        ctx.fillStyle = 'rgba(0,0,0,0.15)';
        ctx.fillRect(0, 0, w, h);
        const bw = (w / this.data.length) * 2.5;
        let x = 0;
        for (let i = 0; i < this.data.length; i++) {
            const nv = this.data[i] / 255;
            const bh = nv * h;
            const l = 40 + (nv * 20);
            ctx.fillStyle = `hsla(0,100%,${l}%,${nv})`;
            ctx.fillRect(x, h - bh, bw, bh);
            x += bw + 1;
        }
    }
};

const AR = {
    init: false,
    actx: null,
    src: null,
    filt: null,
    gain: null,
    play: false,
    phase: 0,
    hint: null,
    scene: null,
    async init() {
        console.log('üé¨ AR INIT');
        this.scene = document.getElementById('arScene');
        this.scene.style.display = 'block';
        
        if (this.scene.hasLoaded) this.setup();
        else this.scene.addEventListener('loaded', () => this.setup());
        
        if (!this.init) { this.events(); this.init = true; }
        this.reset();
    },
    setup() {
        console.log('‚úÖ Escena lista');
    },
    events() {
        document.getElementById('btnStartAR').addEventListener('click', () => this.start());
    },
    reset() {
        const btn = document.getElementById('btnStartAR');
        btn.classList.add('visible');
        btn.innerHTML = 'üé¨ INICIAR ANIMACI√ìN';
        btn.disabled = false;
        document.getElementById('arStatusText').textContent = 'Apunta la c√°mara al suelo para ver la escena';
        document.getElementById('hudValue').textContent = '0 dB';
        document.getElementById('hudFill').style.width = '0%';
        this.play = false;
        this.phase = 0;
    },
    destroy() {
        if (this.src) { try { this.src.stop(); } catch (e) {} this.src = null; }
        if (this.actx) { this.actx.close(); this.actx = null; }
        if (this.hint) { clearInterval(this.hint); this.hint = null; }
        if (this.scene) this.scene.style.display = 'none';
        this.play = false;
        this.phase = 0;
    },
    hud(db, col = '#D71920') {
        document.getElementById('hudValue').textContent = `${db} dB`;
        document.getElementById('hudValue').style.color = col;
        const p = Math.min(100, (db / 120) * 100);
        document.getElementById('hudFill').style.width = `${p}%`;
        if (col === '#34c759') document.getElementById('hudFill').style.background = 'linear-gradient(90deg,#34c759,#30d158)';
        else document.getElementById('hudFill').style.background = 'linear-gradient(90deg,#D71920,#ff6b6b)';
    },
    async loadAud() {
        try {
            const AC = window.AudioContext || window.webkitAudioContext;
            this.actx = new AC();
            const res = await fetch(CFG.audioFile);
            if (!res.ok) throw new Error('No audio');
            const ab = await res.arrayBuffer();
            const buf = await this.actx.decodeAudioData(ab);
            this.src = this.actx.createBufferSource();
            this.src.buffer = buf;
            this.src.loop = true;
            this.filt = this.actx.createBiquadFilter();
            this.filt.type = 'lowpass';
            this.filt.frequency.value = 22000;
            this.gain = this.actx.createGain();
            this.gain.gain.value = 0.7;
            this.src.connect(this.filt);
            this.filt.connect(this.gain);
            this.gain.connect(this.actx.destination);
            this.src.start(0);
            console.log('‚úÖ Audio OK');
            return true;
        } catch (e) {
            console.log('üîá Silencio');
            return false;
        }
    },
    async start() {
        if (this.play) return;
        this.play = true;
        const btn = document.getElementById('btnStartAR');
        btn.innerHTML = '<span class="loading-spinner"></span> CARGANDO...';
        btn.disabled = true;
        await this.loadAud();
        btn.classList.remove('visible');
        setTimeout(() => this.p1(), 500);
    },
    p1() {
        console.log('üìç FASE 1');
        this.phase = 1;
        document.getElementById('arStatusText').textContent = '‚ö†Ô∏è Exposici√≥n a ruido peligroso - 105 dB';
        document.getElementById('dangerOverlay').classList.add('active');
        
        const sw = document.getElementById('soundWaves');
        const ip = document.getElementById('infoPanel');
        const dl = document.getElementById('dangerLight');
        const ms = document.getElementById('mouthShape');
        const sr = document.getElementById('stickmanRoot');
        
        if (sw) sw.setAttribute('visible', 'true');
        if (ip) ip.setAttribute('visible', 'true');
        if (dl) this.pulseLt(dl);
        if (ms) ms.setAttribute('rotation', '180 0 0');
        if (sr) this.shake(sr);
        
        this.hudAnim(105);
        setTimeout(() => this.p2(), 4000);
    },
    pulseLt(el) {
        let on = true;
        const p = () => {
            if (this.phase >= 5) return;
            el.setAttribute('light', 'intensity', on ? 3 : 0.5);
            on = !on;
            setTimeout(p, 350);
        };
        p();
    },
    shake(el) {
        let a = -3;
        const s = () => {
            if (this.phase !== 1) { el.setAttribute('rotation', '0 0 0'); return; }
            el.setAttribute('rotation', `0 0 ${a}`);
            a = a === -3 ? 3 : -3;
            setTimeout(s, 60);
        };
        s();
    },
    p2() {
        console.log('üìç FASE 2');
        this.phase = 2;
        document.getElementById('arStatusText').textContent = 'Protecci√≥n insuficiente con las manos';
        
        const ls = document.getElementById('leftShoulder');
        const lua = document.getElementById('leftUpperArm');
        const rs = document.getElementById('rightShoulder');
        const rua = document.getElementById('rightUpperArm');
        
        if (ls) this.anim(ls, 'rotation', '0 0 85', 1000);
        if (lua) this.anim(lua, 'rotation', '0 0 -95', 1000);
        if (rs) this.anim(rs, 'rotation', '0 0 -85', 1000);
        if (rua) this.anim(rua, 'rotation', '0 0 95', 1000);
        
        this.hud(95);
        setTimeout(() => this.p3(), 4000);
    },
    p3() {
        console.log('üìç FASE 3');
        this.phase = 3;
        document.getElementById('arStatusText').textContent = 'Buscando protecci√≥n auditiva...';
        
        const sr = document.getElementById('stickmanRoot');
        const ls = document.getElementById('leftShoulder');
        const lua = document.getElementById('leftUpperArm');
        const rs = document.getElementById('rightShoulder');
        const rua = document.getElementById('rightUpperArm');
        const lt = document.getElementById('leftThigh');
        const rt = document.getElementById('rightThigh');
        
        if (ls) this.anim(ls, 'rotation', '0 0 15', 600);
        if (lua) this.anim(lua, 'rotation', '0 0 15', 600);
        if (rs) this.anim(rs, 'rotation', '0 0 -15', 600);
        if (rua) this.anim(rua, 'rotation', '0 0 -15', 600);
        
        setTimeout(() => {
            if (sr) this.anim(sr, 'rotation', '0 -50 0', 1200);
            setTimeout(() => {
                if (lt) this.walk(lt, '0 0 3', '35 0 3', 450, 5);
                if (rt) this.walk(rt, '0 0 -3', '-35 0 -3', 450, 5);
                if (ls) this.walk(ls, '0 0 15', '35 0 15', 450, 5);
                if (rs) this.walk(rs, '0 0 -15', '-35 0 -15', 450, 5);
                if (sr) this.anim(sr, 'position', '0.7 0 0', 2250);
            }, 1300);
        }, 700);
        
        setTimeout(() => this.p4(), 4700);
    },
    p4() {
        console.log('üìç FASE 4');
        this.phase = 4;
        document.getElementById('arStatusText').textContent = 'Colocando protecci√≥n auditiva...';
        
        const lt = document.getElementById('leftThigh');
        const rt = document.getElementById('rightThigh');
        const ls = document.getElementById('leftShoulder');
        const rs = document.getElementById('rightShoulder');
        const rua = document.getElementById('rightUpperArm');
        const rfa = document.getElementById('rightForearm');
        const hp = document.getElementById('headphonesGroup');
        
        if (lt) lt.setAttribute('rotation', '0 0 3');
        if (rt) rt.setAttribute('rotation', '0 0 -3');
        
        if (rs) this.anim(rs, 'rotation', '0 0 -75', 1200);
        if (rua) this.anim(rua, 'rotation', '0 0 50', 1200);
        if (rfa) setTimeout(() => this.anim(rfa, 'rotation', '0 0 -40', 1200), 400);
        
        setTimeout(() => {
            if (hp) {
                this.anim(hp, 'position', '0.7 0.62 0', 1800);
                this.anim(hp, 'scale', '0.65 0.65 0.65', 1800);
            }
        }, 1400);
        
        setTimeout(() => this.p5(), 3500);
    },
    p5() {
        console.log('üìç FASE 5');
        this.phase = 5;
        document.getElementById('arStatusText').textContent = '‚úÖ Protecci√≥n auditiva efectiva';
        
        const hp = document.getElementById('headphonesGroup');
        const ls = document.getElementById('leftShoulder');
        const rs = document.getElementById('rightShoulder');
        const rua = document.getElementById('rightUpperArm');
        const rfa = document.getElementById('rightForearm');
        const sw = document.getElementById('soundWaves');
        const dl = document.getElementById('dangerLight');
        const ms = document.getElementById('mouthShape');
        const it = document.getElementById('infoTitle');
        const is = document.getElementById('infoSubtitle');
        
        if (hp) {
            hp.setAttribute('position', '0.7 0.62 0');
            hp.setAttribute('scale', '0.6 0.6 0.6');
        }
        
        if (ls) this.anim(ls, 'rotation', '0 0 15', 900);
        if (rs) this.anim(rs, 'rotation', '0 0 -15', 900);
        if (rua) this.anim(rua, 'rotation', '0 0 -15', 900);
        if (rfa) this.anim(rfa, 'rotation', '0 0 -5', 900);
        
        if (this.actx && this.filt && this.gain) {
            const t = this.actx.currentTime;
            this.filt.frequency.exponentialRampToValueAtTime(250, t + 2.5);
            this.gain.gain.exponentialRampToValueAtTime(0.05, t + 2.5);
        }
        
        if (sw) sw.setAttribute('visible', 'false');
        document.getElementById('dangerOverlay').classList.remove('active');
        if (dl) dl.setAttribute('light', 'intensity', 0);
        if (ms) ms.setAttribute('rotation', '0 0 0');
        if (it) {
            it.setAttribute('value', '‚úÖ 60 dB - SEGURO ‚úÖ');
            it.setAttribute('color', '#00FF00');
        }
        if (is) is.setAttribute('value', 'Protecci√≥n auditiva efectiva aplicada');
        
        this.hud(60, '#34c759');
        setTimeout(() => this.p6(), 3000);
    },
    p6() {
        console.log('üìç FASE 6');
        this.phase = 6;
        document.getElementById('arStatusText').textContent = '‚úÖ Simulaci√≥n completada';
    },
    hudAnim(idb) {
        if (this.hint) clearInterval(this.hint);
        this.hint = setInterval(() => {
            if (this.phase <= 2) this.hud(95 + Math.floor(Math.random() * 15));
            else if (this.phase >= 5) this.hud(55 + Math.floor(Math.random() * 10), '#34c759');
        }, 200);
    },
    anim(el, prop, to, dur) {
        if (!el) return;
        el.setAttribute('animation', `property:${prop};to:${to};dur:${dur};easing:easeInOutQuad`);
    },
    walk(el, from, to, dur, loop) {
        if (!el) return;
        el.setAttribute('animation', `property:rotation;from:${from};to:${to};dir:alternate;dur:${dur};loop:${loop};easing:easeInOutSine`);
    }
};

window.addEventListener('load', () => {
    console.log('üöÄ LANXESS AR v18.0 FINAL');
    Router.init();
});
    </script>
</body>
</html>
