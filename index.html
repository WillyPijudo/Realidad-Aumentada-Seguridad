<!DOCTYPE html>
<html>
<head>
    <title>Seguridad Industrial AR</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Roboto', sans-serif; }
        
        /* -- INTERFAZ MEJORADA -- */
        #ui-layer {
            position: fixed; bottom: 40px; left: 0; width: 100%;
            display: flex; justify-content: center; pointer-events: none; z-index: 999;
        }

        .btn {
            pointer-events: auto;
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            color: white; border: none; padding: 15px 40px;
            font-size: 18px; font-weight: bold; border-radius: 50px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            display: none; /* Oculto al inicio */
            text-transform: uppercase; letter-spacing: 1px;
        }

        .btn:active { transform: scale(0.95); box-shadow: 0 5px 10px rgba(0,0,0,0.2); }

        #btn-start { display: block; background: #3498db; } /* Azul para inicio */
        #btn-protect { background: #2ecc71; display: none; } /* Verde para proteger */

        /* Aviso flotante */
        #overlay-text {
            position: fixed; top: 20px; width: 100%; text-align: center;
            color: white; font-weight: bold; text-shadow: 0 2px 4px black;
            font-size: 24px; display: none; z-index: 998;
        }
        
        .pulse { animation: pulse-anim 1.5s infinite; }
        @keyframes pulse-anim {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body style="margin: 0px; overflow: hidden;">

    <div id="overlay-text">‚ö†Ô∏è RUIDO CR√çTICO DETECTADO</div>

    <div id="ui-layer">
        <button id="btn-start" class="btn pulse">üîä ACTIVAR SIMULACI√ìN</button>
        <button id="btn-protect" class="btn">üéß PONERSE PROTECCI√ìN</button>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">
        
        <a-light type="directional" position="1 1 1" intensity="1.5"></a-light>
        <a-light type="ambient" intensity="0.8"></a-light>

        <a-marker preset="hiro" smooth="true">
            
            <a-entity id="ar-content" visible="false">
                
                <a-entity position="0 0.5 0" animation="property: position; to: 0 0.6 0; dir: alternate; loop: true; dur: 2000">
                    
                    <a-torus arc="190" radius="0.6" radius-tubular="0.08" position="0 0 0" rotation="0 90 0" color="#1a1a1a"></a-torus>

                    <a-entity position="-0.65 -0.1 0">
                        <a-cylinder color="#f1c40f" height="0.3" radius="0.25" rotation="0 0 90"></a-cylinder>
                        <a-torus color="#111" radius="0.25" radius-tubular="0.08" rotation="0 90 0" position="-0.1 0 0" scale="1 1 0.6"></a-torus>
                        <a-sphere color="#555" radius="0.05" position="0 0.25 0"></a-sphere>
                    </a-entity>

                    <a-entity position="0.65 -0.1 0">
                        <a-cylinder color="#f1c40f" height="0.3" radius="0.25" rotation="0 0 90"></a-cylinder>
                        <a-torus color="#111" radius="0.25" radius-tubular="0.08" rotation="0 90 0" position="0.1 0 0" scale="1 1 0.6"></a-torus>
                        <a-sphere color="#555" radius="0.05" position="0 0.25 0"></a-sphere>
                    </a-entity>

                </a-entity>

                <a-entity id="final-message" visible="false" position="0 0 0.5" rotation="-90 0 0">
                     <a-plane color="#000" opacity="0.8" width="4" height="2.5"></a-plane>
                     <a-text 
                        value="PROTECCION ACTIVA\n\nEl uso correcto de EPP\nevita la hipoacusia\nlaboral permanente."
                        align="center" color="#2ecc71" width="3.8" position="0 0 0.1">
                     </a-text>
                </a-entity>

            </a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // --- SISTEMA DE AUDIO INDUSTRIAL MEJORADO ---
        let audioCtx, masterGain;
        let oscillators = [];
        let isProtected = false;
        let sourceFile = null; // Variable por si usas MP3 real

        function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            masterGain = audioCtx.createGain();
            masterGain.connect(audioCtx.destination);
            
            // --- OPCI√ìN A: Generador de Zumbido de F√°brica (Sint√©tico) ---
            // Creamos 3 osciladores graves para simular maquinaria pesada
            const freqs = [55, 110, 220]; // Frecuencias graves (Hertz)
            
            freqs.forEach(f => {
                const osc = audioCtx.createOscillator();
                osc.type = 'sawtooth'; // Onda diente de sierra (suena √°spero/mec√°nico)
                osc.frequency.value = f;
                
                // Un filtro para quitarle lo "electr√≥nico" y que suene "ahogado" como motor
                const lowPass = audioCtx.createBiquadFilter();
                lowPass.type = 'lowpass';
                lowPass.frequency.value = 400;

                const oscGain = audioCtx.createGain();
                oscGain.gain.value = 0.3; // Volumen individual

                osc.connect(lowPass);
                lowPass.connect(oscGain);
                oscGain.connect(masterGain);
                
                osc.start();
                oscillators.push(osc);
            });

            // Agregamos Ruido Blanco para "vapor/aire"
            const bufferSize = audioCtx.sampleRate * 2;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
            
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            noise.loop = true;
            const noiseGain = audioCtx.createGain();
            noiseGain.gain.value = 0.1;
            noise.connect(masterGain);
            noise.start();
            oscillators.push(noise);

            // --- OPCI√ìN B: MP3 REAL (Descomenta esto si subes un archivo) ---
            /*
            const audioEl = new Audio('fabrica.mp3'); // TU ARCHIVO AQU√ç
            audioEl.loop = true;
            audioEl.crossOrigin = "anonymous";
            sourceFile = audioCtx.createMediaElementSource(audioEl);
            sourceFile.connect(masterGain);
            audioEl.play();
            // Nota: Si usas MP3, comenta la parte de los osciladores de arriba para que no se mezclen
            */
        }

        // ELEMENTOS UI
        const btnStart = document.getElementById('btn-start');
        const btnProtect = document.getElementById('btn-protect');
        const overlay = document.getElementById('overlay-text');
        const arContent = document.getElementById('ar-content');
        const finalMsg = document.getElementById('final-message');
        const headphonesModel = arContent.querySelector('a-entity'); // El grupo de auriculares

        // 1. INICIAR
        btnStart.addEventListener('click', () => {
            initAudio();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            // UI Update
            btnStart.style.display = 'none';
            btnProtect.style.display = 'block';
            overlay.style.display = 'block';
            arContent.setAttribute('visible', true);
            
            // Efecto visual de alerta (Fondo rojo intermitente simulado)
            document.body.style.animation = "pulse-bg 0.5s infinite alternate";
        });

        // 2. PROTEGER
        btnProtect.addEventListener('click', () => {
            if(isProtected) return;
            isProtected = true;

            // BAJAR VOLUMEN Y FILTRAR (Efecto Muffled)
            // Bajamos volumen al 10%
            masterGain.gain.exponentialRampToValueAtTime(0.1, audioCtx.currentTime + 1);
            
            // Si estuvi√©ramos usando un MP3, aqu√≠ podr√≠amos aplicar un filtro LowPass extra
            // Pero bajar el volumen dr√°sticamente ya simula bien la protecci√≥n

            // CAMBIOS VISUALES
            document.body.style.animation = "none"; // Quitar alerta roja
            document.body.style.backgroundColor = "transparent";
            overlay.style.color = "#2ecc71";
            overlay.innerText = "‚úÖ PROTEGIDO";
            
            btnProtect.style.display = 'none';
            
            // Ocultar auriculares 3D y mostrar mensaje
            headphonesModel.setAttribute('visible', false);
            finalMsg.setAttribute('visible', true);
        });
        
        // Estilo din√°mico para alerta roja
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes pulse-bg {
                from { background-color: rgba(255, 0, 0, 0); }
                to { background-color: rgba(255, 0, 0, 0.3); }
            }
        `;
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>
