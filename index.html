<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#111111">
    <title>Seguridad Industrial AR</title>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        /* --- ESTILOS VISUALES CORREGIDOS --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;900&display=swap');

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            /* dvh = Dynamic Viewport Height (Se adapta a la barra del navegador) */
            height: 100dvh; 
            background-color: #000;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- PANTALLA DE INICIO (OVERLAY) --- */
        #start-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.95);
            z-index: 9999; /* Siempre encima de todo */
            display: flex;
            flex-direction: column;
            justify-content: center; /* Centrado Vertical REAL */
            align-items: center;     /* Centrado Horizontal REAL */
            padding: 20px;
            text-align: center;
        }

        .title-box {
            margin-bottom: 40px;
            border: 2px solid #f1c40f;
            padding: 20px;
            background: rgba(241, 196, 15, 0.1);
        }

        h1 {
            color: #f1c40f;
            font-size: 28px;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        p { color: #ccc; font-size: 16px; margin-top: 10px; max-width: 300px; line-height: 1.5; }

        /* --- UI DURANTE LA EXPERIENCIA --- */
        #hud-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1000;
            pointer-events: none; /* Dejar pasar toques al 3D */
            display: none; /* Oculto al inicio */
            flex-direction: column;
            justify-content: space-between;
        }

        /* Panel Superior (Medidor) */
        .top-panel {
            padding: 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
            display: flex; justify-content: center;
        }

        #db-card {
            background: #1e272e;
            border: 2px solid #ff4757;
            padding: 15px 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            min-width: 200px;
        }

        .db-label { font-size: 12px; color: #aaa; letter-spacing: 1px; margin-bottom: 5px; }
        .db-number { font-size: 32px; font-weight: 900; color: #ff4757; }
        .db-bar-bg { width: 100%; height: 8px; background: #333; margin-top: 5px; border-radius: 4px; }
        .db-bar-fill { width: 100%; height: 100%; background: #ff4757; border-radius: 4px; transition: width 0.1s; }

        /* Panel Inferior (Botones) */
        .bottom-panel {
            padding: 40px 20px;
            text-align: center;
            pointer-events: auto; /* Reactivar toques */
        }

        /* BOTONES GRANDES */
        .btn-big {
            background: white;
            color: black;
            border: none;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: 900;
            border-radius: 50px;
            text-transform: uppercase;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.2);
            width: 100%;
            max-width: 320px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn-big:active { transform: scale(0.95); }

        #btn-start { background: #3498db; color: white; }
        #btn-protect { background: #2ecc71; color: white; display: none; margin: 0 auto; }

        /* TEXTO GU√çA FLOTANTE */
        #ar-guide {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.7);
            font-size: 18px;
            text-align: center;
            width: 80%;
            pointer-events: none;
        }

        /* CLASES DE ESTADO */
        .safe-mode { border-color: #2ecc71 !important; }
        .safe-text { color: #2ecc71 !important; }
        .safe-fill { background: #2ecc71 !important; }
        .danger-screen { animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0% { box-shadow: inset 0 0 0 transparent; } 50% { box-shadow: inset 0 0 50px rgba(255,0,0,0.5); } 100% { box-shadow: inset 0 0 0 transparent; } }

    </style>
</head>
<body>

    <div id="start-screen">
        <div class="title-box">
            <h1>Seguridad<br>Industrial</h1>
            <div style="width: 50px; height: 4px; background: #f1c40f; margin: 10px auto;"></div>
            <p>Experiencia de Realidad Aumentada</p>
        </div>
        
        <p style="margin-bottom: 30px; font-size: 14px;">1. Sube el volumen.<br>2. Presiona iniciar.<br>3. Apunta al marcador.</p>
        
        <button id="btn-start" class="btn-big">INICIAR EXPERIENCIA</button>
        <div id="error-msg" style="color: red; margin-top: 20px; display: none; font-size: 12px;"></div>
    </div>

    <div id="hud-layer">
        <div class="top-panel">
            <div id="db-card">
                <div class="db-label">NIVEL DE RUIDO</div>
                <div class="db-number" id="db-val">0 dB</div>
                <div class="db-bar-bg"><div class="db-bar-fill" id="db-fill"></div></div>
            </div>
        </div>

        <div id="ar-guide">BUSCANDO MARCADOR...</div>

        <div class="bottom-panel">
            <button id="btn-protect" class="btn-big">PONERSE PROTECCI√ìN üéß</button>
        </div>
    </div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true;">
        
        <a-light type="ambient" intensity="0.6"></a-light>
        <a-light type="directional" position="1 2 1" intensity="1.5"></a-light>

        <a-marker type="pattern" url="pattern-marker.patt" smooth="true">
            <a-entity id="ar-content" visible="false">
                
                <a-entity id="headphones" position="0 0.5 0" animation="property: position; dir: alternate; to: 0 0.6 0; loop: true; dur: 2000">
                    
                    <a-torus color="#111" radius="0.5" radius-tubular="0.06" arc="190" rotation="90 0 0" position="0 0.3 0"></a-torus>
                    
                    <a-entity position="-0.55 0.3 0">
                        <a-cylinder color="#f1c40f" height="0.25" radius="0.25" rotation="0 0 90"></a-cylinder>
                        <a-torus color="#222" radius="0.25" radius-tubular="0.08" rotation="0 90 0" position="-0.05 0 0" scale="1 1 0.6"></a-torus>
                        <a-text value="PELIGRO" color="red" rotation="0 -90 0" position="-0.3 0 0" align="center" width="3"></a-text>
                    </a-entity>

                    <a-entity position="0.55 0.3 0">
                        <a-cylinder color="#f1c40f" height="0.25" radius="0.25" rotation="0 0 90"></a-cylinder>
                        <a-torus color="#222" radius="0.25" radius-tubular="0.08" rotation="0 90 0" position="0.05 0 0" scale="1 1 0.6"></a-torus>
                        <a-text value="RUIDO" color="red" rotation="0 90 0" position="0.3 0 0" align="center" width="3"></a-text>
                    </a-entity>

                </a-entity>

                <a-entity id="msg-final" visible="false" position="0 0.5 0" rotation="-45 0 0">
                    <a-plane color="#000" opacity="0.9" width="3.5" height="1.8"></a-plane>
                    <a-text value="¬°PROTEGIDO!" color="#2ecc71" align="center" width="6" position="0 0.4 0.1"></a-text>
                    <a-text value="Nivel de ruido seguro." color="#fff" align="center" width="4" position="0 0 0.1"></a-text>
                    <a-circle color="#2ecc71" radius="0.2" position="0 -0.5 0.1"></a-circle>
                </a-entity>

            </a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // CONFIGURACI√ìN
        const audioFile = 'Sonidos_De_Fabrica.wav';

        // REFERENCIAS
        const startScreen = document.getElementById('start-screen');
        const hudLayer = document.getElementById('hud-layer');
        const btnStart = document.getElementById('btn-start');
        const btnProtect = document.getElementById('btn-protect');
        const errorMsg = document.getElementById('error-msg');
        
        // ELEMENTOS HUD
        const dbCard = document.getElementById('db-card');
        const dbVal = document.getElementById('db-val');
        const dbFill = document.getElementById('db-fill');
        const arGuide = document.getElementById('ar-guide');
        
        // ELEMENTOS AR
        const marker = document.querySelector('a-marker');
        const arContent = document.getElementById('ar-content');
        const headphones = document.getElementById('headphones');
        const msgFinal = document.getElementById('msg-final');

        // AUDIO SYSTEM
        let audioCtx, source, gainNode, filterNode;
        let isProtected = false;
        let meterInterval;

        // 1. CLICK EN INICIAR (CARGA SEGURA)
        btnStart.addEventListener('click', async () => {
            btnStart.innerText = "CARGANDO...";
            btnStart.style.opacity = "0.7";

            try {
                // Crear contexto de audio (Web Audio API)
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();

                // Cargar archivo
                const response = await fetch(audioFile);
                if (!response.ok) throw new Error("404 No encontrado");
                
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

                // Configurar nodos
                source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;
                source.loop = true;

                filterNode = audioCtx.createBiquadFilter();
                filterNode.type = 'lowpass';
                filterNode.frequency.value = 22000; // Abierto

                gainNode = audioCtx.createGain();
                gainNode.gain.value = 1.0;

                // Conectar
                source.connect(filterNode);
                filterNode.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                // Reproducir
                source.start(0);

                // TRANSICI√ìN EXITOSA
                startScreen.style.display = 'none';
                hudLayer.style.display = 'flex';
                document.body.classList.add('danger-screen'); // Efecto rojo
                simulateNoise(); // Iniciar n√∫meros

            } catch (e) {
                console.error(e);
                errorMsg.style.display = 'block';
                errorMsg.innerText = "Error: No se encuentra 'Sonidos_De_Fabrica.wav'. Revisa GitHub.";
                btnStart.innerText = "REINTENTAR";
                btnStart.style.opacity = "1";
                // AUNQUE FALLE, DEJAMOS ENTRAR PARA PROBAR AR
                setTimeout(() => {
                    if(confirm("El audio fall√≥. ¬øEntrar sin sonido?")) {
                        startScreen.style.display = 'none';
                        hudLayer.style.display = 'flex';
                    }
                }, 500);
            }
        });

        // 2. DETECTAR MARCADOR
        marker.addEventListener('markerFound', () => {
            arContent.setAttribute('visible', true);
            arGuide.style.display = 'none';
            if(!isProtected) btnProtect.style.display = 'block';
        });

        marker.addEventListener('markerLost', () => {
            // arContent.setAttribute('visible', false); // Opcional
        });

        // 3. PROTEGER
        btnProtect.addEventListener('click', () => {
            isProtected = true;

            // Audio Effect
            if(audioCtx) {
                const now = audioCtx.currentTime;
                filterNode.frequency.exponentialRampToValueAtTime(300, now + 1);
                gainNode.gain.exponentialRampToValueAtTime(0.2, now + 1);
            }

            // Visual Effect
            btnProtect.style.display = 'none';
            document.body.classList.remove('danger-screen');
            
            dbCard.classList.add('safe-mode');
            dbVal.classList.add('safe-text');
            dbFill.classList.add('safe-fill');
            
            headphones.setAttribute('visible', false);
            msgFinal.setAttribute('visible', true);
        });

        // SIMULADOR VISUAL DE DB
        function simulateNoise() {
            meterInterval = setInterval(() => {
                let db, width;
                if(!isProtected) {
                    db = Math.floor(Math.random() * (105 - 95) + 95);
                    width = (db / 110) * 100;
                } else {
                    db = Math.floor(Math.random() * (75 - 65) + 65);
                    width = (db / 110) * 100;
                }
                dbVal.innerText = db + " dB";
                dbFill.style.width = width + "%";
            }, 100);
        }

    </script>
</body>
</html>
