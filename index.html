<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <title>Seguridad Auditiva Industrial AR</title>

    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        /* Reset b√°sico del navegador para evitar m√°rgenes inesperados */
        * {
            box-sizing: border-box;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Evita barras de desplazamiento durante la experiencia AR */
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #000; /* Fondo negro mientras carga la c√°mara */
        }

        /* --- PANTALLA DE CARGA INICIAL --- */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            z-index: 9999; /* Asegura que est√© siempre encima de todo */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            transition: opacity 0.5s ease-out; /* Transici√≥n suave al desaparecer */
        }

        .loader-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #f1c40f; /* Color amarillo seguridad */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-text {
            font-size: 18px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* --- CAPA DE INTERFAZ DE USUARIO (UI LAYER) --- */
        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Permite que los toques pasen a trav√©s de la capa transparente */
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* Alinea los controles abajo */
            align-items: center;
            padding-bottom: 40px; /* Espacio desde el borde inferior */
        }

        /* --- ESTILOS DE LOS BOTONES --- */
        .btn-container {
            pointer-events: auto; /* Reactiva los toques solo para los botones */
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .btn {
            border: none;
            padding-top: 15px;
            padding-bottom: 15px;
            padding-left: 40px;
            padding-right: 40px;
            font-size: 18px;
            font-weight: 700; /* Bold */
            border-radius: 50px; /* Bordes completamente redondeados */
            cursor: pointer;
            box-shadow: 0px 10px 20px rgba(0, 0, 0, 0.4);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Efecto de rebote suave */
            text-transform: uppercase;
            letter-spacing: 0.5px;
            outline: none;
            display: none; /* Ocultos por defecto hasta que cargue el sistema */
        }

        .btn:active {
            transform: scale(0.95); /* Efecto de presionado */
            box-shadow: 0px 5px 10px rgba(0, 0, 0, 0.2);
        }

        #btn-start {
            background-color: #3498db; /* Azul */
            color: white;
        }

        #btn-protect {
            background-color: #2ecc71; /* Verde */
            color: white;
        }

        /* Animaci√≥n de pulso para llamar la atenci√≥n al bot√≥n de inicio */
        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(52, 152, 219, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }

        /* --- ALERTA VISUAL EN PANTALLA --- */
        #alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 0, 0, 0); /* Transparente al inicio */
            z-index: 500;
            pointer-events: none;
            transition: background-color 0.5s ease;
        }

        #alert-text-container {
            position: fixed;
            top: 30px;
            width: 100%;
            text-align: center;
            z-index: 1001;
            display: none;
        }

        .alert-text {
            font-size: 26px;
            font-weight: 900;
            color: #e74c3c; /* Rojo peligro */
            text-shadow: 2px 2px 4px #000000;
            background-color: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 10px;
            display: inline-block;
        }

        /* Animaci√≥n de fondo rojo parpadeante */
        .danger-mode {
            animation: danger-pulse 0.8s infinite alternate;
        }

        @keyframes danger-pulse {
            from { background-color: rgba(255, 0, 0, 0.1); }
            to { background-color: rgba(255, 0, 0, 0.4); }
        }

        /* --- ESTADO PROTEGIDO --- */
        .safe-mode-text {
            color: #2ecc71 !important; /* Verde seguridad */
            border: 2px solid #2ecc71;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader-spinner"></div>
        <div id="loading-text">Iniciando Sistema AR...</div>
        <div style="font-size: 12px; margin-top: 10px; color: #aaa;">Por favor, permite el acceso a la c√°mara.</div>
    </div>

    <div id="alert-overlay"></div>
    <div id="alert-text-container">
        <div id="main-alert-text" class="alert-text">‚ö†Ô∏è RIESGO AUDITIVO DETECTADO</div>
    </div>

    <div id="ui-layer">
        <div class="btn-container">
            <button id="btn-start" class="btn pulse-animation">üîä ACTIVAR SIMULACI√ìN</button>
            <button id="btn-protect" class="btn">üéß COLOCAR PROTECCI√ìN EPP</button>
        </div>
    </div>

    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono; maxDetectionRate: 60;"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true;"
        vr-mode-ui="enabled: false"
        id="main-scene">
        
        <a-light type="ambient" color="#ffffff" intensity="0.7"></a-light>
        <a-light type="directional" color="#ffffff" intensity="1.2" position="-1 2 3" cast-shadow="true"></a-light>


        <a-marker preset="hiro" id="hiro-marker-anchor">
            
            <a-entity id="ar-content-container" visible="false">
                
                <a-entity 
                    id="earmuffs-model-group"
                    position="0 0.5 0" 
                    scale="1.2 1.2 1.2"
                    animation="property: position; to: 0 0.65 0; dir: alternate; loop: true; dur: 2500; easing: easeInOutSine"
                    animation__rotate="property: rotation; to: 0 360 0; loop: true; dur: 15000; easing: linear">
                    
                    <a-torus 
                        arc="200" 
                        radius="0.7" 
                        radius-tubular="0.08" 
                        position="0 0 0" 
                        rotation="0 90 0" 
                        color="#2c3e50"
                        roughness="0.5">
                    </a-torus>
                    <a-torus 
                        arc="160" 
                        radius="0.68" 
                        radius-tubular="0.1" 
                        position="0 -0.05 0" 
                        rotation="0 90 0" 
                        color="#1a1a1a"
                        roughness="0.9">
                    </a-torus>

                    <a-entity position="-0.75 -0.1 0">
                        <a-cylinder color="#f1c40f" height="0.35" radius="0.3" rotation="0 0 90" metalness="0.1"></a-cylinder>
                        <a-sphere color="#f1c40f" radius="0.3" position="-0.15 0 0" scale="0.5 1 1"></a-sphere>
                        <a-torus color="#111" radius="0.3" radius-tubular="0.1" rotation="0 90 0" position="-0.12 0 0" scale="1 1 0.6" roughness="0.8"></a-torus>
                        <a-cylinder color="#7f8c8d" height="0.1" radius="0.05" position="0 0.25 0"></a-cylinder>
                    </a-entity>

                    <a-entity position="0.75 -0.1 0">
                        <a-cylinder color="#f1c40f" height="0.35" radius="0.3" rotation="0 0 90" metalness="0.1"></a-cylinder>
                        <a-sphere color="#f1c40f" radius="0.3" position="0.15 0 0" scale="0.5 1 1"></a-sphere>
                        <a-torus color="#111" radius="0.3" radius-tubular="0.1" rotation="0 90 0" position="0.12 0 0" scale="1 1 0.6" roughness="0.8"></a-torus>
                        <a-cylinder color="#7f8c8d" height="0.1" radius="0.05" position="0 0.25 0"></a-cylinder>
                    </a-entity>

                    <a-text 
                        value="PROTECCION REQUERIDA"
                        align="center"
                        color="#e74c3c"
                        position="0 -0.8 0"
                        width="4"
                        font="roboto"
                        side="double">
                    </a-text>
                </a-entity>

                <a-entity 
                    id="final-safety-message" 
                    visible="false" 
                    position="0 0.2 0.5" 
                    rotation="-45 0 0">
                     
                     <a-plane 
                        color="#2c3e50" 
                        opacity="0.9" 
                        width="4.5" 
                        height="3"
                        border-radius="0.5">
                    </a-plane>
                     
                     <a-text 
                        value="¬°BIEN HECHO!"
                        align="center" 
                        color="#2ecc71" 
                        width="5" 
                        position="0 1 0.1"
                        font="roboto"
                        font-weight="bold">
                     </a-text>

                     <a-text 
                        value="No te olvides de llevar auriculares.\n\nSin importar el lugar,\nlos ruidos fuertes pueden\nafectar permanentemente\ntu salud auditiva."
                        align="center" 
                        color="#ffffff" 
                        width="3.8" 
                        position="0 0 0.1"
                        font="roboto"
                        wrap-count="25">
                     </a-text>

                     <a-circle color="#2ecc71" radius="0.3" position="0 -1 0.1">
                        <a-text value="‚úì" align="center" color="white" width="6" position="0 0 0"></a-text>
                     </a-circle>
                </a-entity>

            </a-entity> </a-marker>

        <a-entity camera></a-entity>
        
    </a-scene>

    <script>
        // =================================================================
        // VARIABLES GLOBALES Y ESTADO DE LA APLICACI√ìN
        // =================================================================
        
        // Referencias a elementos del DOM (Interfaz de Usuario)
        const uiElements = {
            loadingScreen: document.getElementById('loading-screen'),
            btnStart: document.getElementById('btn-start'),
            btnProtect: document.getElementById('btn-protect'),
            alertOverlay: document.getElementById('alert-overlay'),
            alertTextContainer: document.getElementById('alert-text-container'),
            mainAlertText: document.getElementById('main-alert-text')
        };

        // Referencias a elementos de la escena AR (A-Frame)
        const arElements = {
            scene: document.getElementById('main-scene'),
            marker: document.getElementById('hiro-marker-anchor'),
            contentContainer: document.getElementById('ar-content-container'),
            earmuffsGroup: document.getElementById('earmuffs-model-group'),
            finalMessage: document.getElementById('final-safety-message')
        };

        // Estado del sistema de audio
        const audioSystem = {
            context: null,      // El AudioContext principal
            masterGain: null,   // Control de volumen maestro
            filterNode: null,   // Filtro para el efecto "ahogado"
            oscillators: [],    // Array para guardar los generadores de sonido
            isInitialized: false, // Bandera para saber si el audio ya arranc√≥
            isProtected: false    // Bandera para saber si el usuario activ√≥ la protecci√≥n
        };

        // =================================================================
        // FUNCIONES DE INICIALIZACI√ìN Y EVENTOS DEL SISTEMA
        // =================================================================

        /**
         * Se ejecuta cuando la escena de A-Frame ha terminado de cargar completamente.
         * Es el punto de entrada seguro para empezar a interactuar con la escena.
         */
        document.querySelector('a-scene').addEventListener('loaded', function () {
            console.log("APP: Escena A-Frame cargada correctamente.");
            
            // Ocultamos la pantalla de carga despu√©s de un breve retraso para asegurar estabilidad
            setTimeout(() => {
                uiElements.loadingScreen.style.opacity = '0';
                // Removemos el elemento del DOM una vez terminada la transici√≥n
                setTimeout(() => uiElements.loadingScreen.style.display = 'none', 500);
                
                // Mostramos el bot√≥n inicial
                uiElements.btnStart.style.display = 'block';
                console.log("APP: Interfaz de usuario lista. Esperando interacci√≥n.");
            }, 1500);
        });

        /**
         * EVENTOS DEL MARCADOR HIRO
         * Estos eventos son cruciales para depurar la detecci√≥n.
         */
        
        // Evento: Marcador Encontrado
        arElements.marker.addEventListener('markerFound', () => {
            console.log("AR SYSTEM: ‚úÖ Marcador Hiro detectado.");
            // Si el audio ya se inici√≥, aseguramos que el contenido sea visible
            if (audioSystem.isInitialized) {
                arElements.contentContainer.setAttribute('visible', true);
            }
        });

        // Evento: Marcador Perdido
        arElements.marker.addEventListener('markerLost', () => {
            console.log("AR SYSTEM: ‚ùå Marcador Hiro perdido.");
            // Opcional: Podr√≠as ocultar el contenido si se pierde el marcador
            // arElements.contentContainer.setAttribute('visible', false);
        });


        // =================================================================
        // L√ìGICA DEL SISTEMA DE AUDIO (WEB AUDIO API)
        // =================================================================

        /**
         * Inicializa el contexto de audio y genera los sonidos industriales sint√©ticos.
         * Debe ser llamado por una interacci√≥n del usuario (click) debido a pol√≠ticas del navegador.
         */
        function initializeAudioSystem() {
            if (audioSystem.isInitialized) return;

            console.log("AUDIO: Inicializando sistema de audio...");

            // Crear el AudioContext de manera compatible con distintos navegadores
            const AudioContextConstructor = window.AudioContext || window.webkitAudioContext;
            audioSystem.context = new AudioContextConstructor();

            // Crear nodo de ganancia maestro (Volumen general)
            audioSystem.masterGain = audioSystem.context.createGain();
            audioSystem.masterGain.gain.value = 0.8; // Volumen inicial alto (80%)

            // Crear filtro Biquad (Paso Bajo) para el efecto de protecci√≥n auditiva
            // Inicialmente est√° abierto (22kHz) para dejar pasar todo el sonido
            audioSystem.filterNode = audioSystem.context.createBiquadFilter();
            audioSystem.filterNode.type = 'lowpass';
            audioSystem.filterNode.frequency.value = 22000;
            audioSystem.filterNode.Q.value = 1; // Calidad del filtro

            // Conectar la cadena de audio: Filtro -> Volumen Maestro -> Altavoces
            audioSystem.filterNode.connect(audioSystem.masterGain);
            audioSystem.masterGain.connect(audioSystem.context.destination);

            // --- GENERACI√ìN DE SONIDO INDUSTRIAL SINT√âTICO ---

            // CAPA 1: Zumbido de motor grave (Osciladores)
            // Usamos ondas diente de sierra (sawtooth) por su sonido √°spero y mec√°nico.
            const baseFrequencies = [55, 110, 165]; // Frecuencias bajas en Hz

            baseFrequencies.forEach(freq => {
                const osc = audioSystem.context.createOscillator();
                osc.type = 'sawtooth';
                osc.frequency.value = freq; // Frecuencia base

                // Ganancia individual para cada oscilador para mezclar
                const oscGain = audioSystem.context.createGain();
                oscGain.gain.value = 0.25;

                // Conectar oscilador -> su ganancia -> al filtro principal
                osc.connect(oscGain);
                oscGain.connect(audioSystem.filterNode);
                
                osc.start();
                audioSystem.oscillators.push(osc); // Guardar referencia
            });

            // CAPA 2: Ruido Blanco (Siseo/Vapor/Aire a presi√≥n)
            // Creamos un buffer de 2 segundos con valores aleatorios.
            const bufferSize = audioSystem.context.sampleRate * 2;
            const noiseBuffer = audioSystem.context.createBuffer(1, bufferSize, audioSystem.context.sampleRate);
            const noiseData = noiseBuffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                // Llenamos el buffer con ruido aleatorio entre -1 y 1
                noiseData[i] = Math.random() * 2 - 1;
            }

            const noiseSource = audioSystem.context.createBufferSource();
            noiseSource.buffer = noiseBuffer;
            noiseSource.loop = true; // Reproducir en bucle infinito

            // Ganancia espec√≠fica para el ruido blanco (m√°s baja que los motores)
            const noiseGain = audioSystem.context.createGain();
            noiseGain.gain.value = 0.15;

            // Conectar ruido -> su ganancia -> al filtro principal
            noiseSource.connect(noiseGain);
            noiseGain.connect(audioSystem.filterNode);
            noiseSource.start();
            audioSystem.oscillators.push(noiseSource);

            audioSystem.isInitialized = true;
            console.log("AUDIO: Sistema de audio iniciado y reproduciendo ruido industrial.");
        }

        /**
         * Activa el efecto de protecci√≥n auditiva.
         * Reduce el volumen y aplica un filtro paso bajo intenso.
         */
        function enableHearingProtection() {
            if (audioSystem.isProtected || !audioSystem.context) return;
            
            console.log("AUDIO: Activando protecci√≥n auditiva (Efecto Muffled).");
            audioSystem.isProtected = true;

            const currentTime = audioSystem.context.currentTime;
            const transitionDuration = 0.8; // Duraci√≥n de la transici√≥n en segundos

            // 1. Reducir el volumen dr√°sticamente (del 80% al 10%)
            // Usamos exponentialRampToValueAtTime para un cambio de volumen natural al o√≠do
            audioSystem.masterGain.gain.cancelScheduledValues(currentTime);
            audioSystem.masterGain.gain.setValueAtTime(audioSystem.masterGain.gain.value, currentTime);
            audioSystem.masterGain.gain.exponentialRampToValueAtTime(0.1, currentTime + transitionDuration);

            // 2. Cerrar el filtro paso bajo (de 22kHz a 300Hz)
            // Esto elimina los agudos y deja solo los graves resonantes (efecto "bajo el agua" o con tapones)
            audioSystem.filterNode.frequency.cancelScheduledValues(currentTime);
            audioSystem.filterNode.frequency.setValueAtTime(audioSystem.filterNode.frequency.value, currentTime);
            audioSystem.filterNode.frequency.exponentialRampToValueAtTime(300, currentTime + transitionDuration);
        }


        // =================================================================
        // MANEJADORES DE INTERACCI√ìN DE USUARIO (BOTONES)
        // =================================================================

        // --- BOT√ìN 1: ACTIVAR SIMULACI√ìN ---
        uiElements.btnStart.addEventListener('click', function() {
            console.log("UI: Usuario inici√≥ la simulaci√≥n.");
            
            // 1. Iniciar el audio
            initializeAudioSystem();
            
            // Asegurar que el contexto de audio no est√© suspendido (com√∫n en m√≥viles)
            if (audioSystem.context.state === 'suspended') {
                audioSystem.context.resume();
            }

            // 2. Actualizar la interfaz gr√°fica
            this.style.display = 'none'; // Ocultar bot√≥n de inicio
            uiElements.btnProtect.style.display = 'block'; // Mostrar bot√≥n de protecci√≥n
            
            // Activar alertas visuales
            uiElements.alertTextContainer.style.display = 'block';
            uiElements.alertOverlay.classList.add('danger-mode');

            // 3. Habilitar el contenido AR
            // Se hace visible para que aparezca en cuanto la c√°mara detecte el marcador
            arElements.contentContainer.setAttribute('visible', true);
        });

        // --- BOT√ìN 2: PONERSE PROTECCI√ìN ---
        uiElements.btnProtect.addEventListener('click', function() {
             console.log("UI: Usuario activ√≥ la protecci√≥n.");

             // 1. Aplicar efectos de audio
             enableHearingProtection();

             // 2. Actualizar la interfaz gr√°fica
             this.style.display = 'none'; // Ocultar bot√≥n de protecci√≥n
             
             // Desactivar alertas visuales de peligro
             uiElements.alertOverlay.classList.remove('danger-mode');
             uiElements.alertOverlay.style.backgroundColor = 'transparent';
             
             // Cambiar el texto de alerta a estado seguro
             uiElements.mainAlertText.innerText = "‚úÖ ESTADO: PROTEGIDO";
             uiElements.mainAlertText.classList.add('safe-mode-text');

             // 3. Actualizar la escena AR
             // Ocultar el modelo de los auriculares (porque "ya los tiene puestos")
             arElements.earmuffsGroup.setAttribute('visible', false);
             // Mostrar el mensaje final de concientizaci√≥n
             arElements.finalMessage.setAttribute('visible', true);
        });

    </script>
</body>
</html>
