<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seguridad Industrial AR</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        /* ESTILOS DE LA APP */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; font-family: 'Roboto', sans-serif; background-color: #000; }

        /* MEDIDOR DECIBELIOS */
        #db-panel {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 350px;
            background: rgba(10, 10, 10, 0.9); border: 2px solid #ff4757;
            border-radius: 12px; padding: 15px; z-index: 1000;
            display: none; box-shadow: 0 0 20px rgba(255, 71, 87, 0.3);
            transition: border-color 0.5s;
        }
        .db-header { display: flex; justify-content: space-between; color: #888; font-size: 12px; letter-spacing: 1px; margin-bottom: 5px; }
        #db-number { font-size: 32px; font-weight: 900; color: #ff4757; text-align: right; font-family: monospace; }
        .bar-container { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        #bar-fill { height: 100%; width: 0%; background: #ff4757; transition: width 0.1s linear; }

        /* BOTONES */
        #controls { position: fixed; bottom: 40px; width: 100%; text-align: center; z-index: 1000; pointer-events: none; }
        .btn-action {
            pointer-events: auto; background: white; color: black; border: none;
            padding: 18px 30px; border-radius: 50px; font-size: 16px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); text-transform: uppercase;
            display: none; min-width: 200px;
        }
        #btn-start { display: inline-block; background: #3498db; color: white; }
        #btn-protect { background: #2ecc71; color: white; }

        /* TEXTO GU√çA */
        #guide-text {
            position: fixed; top: 40%; width: 100%; text-align: center;
            color: rgba(255,255,255,0.7); font-size: 18px; pointer-events: none;
        }
        
        /* ALERTA ROJA */
        .danger-zone { animation: pulse-red 1s infinite alternate; }
        @keyframes pulse-red { from { box-shadow: inset 0 0 0 transparent; } to { box-shadow: inset 0 0 50px rgba(255,0,0,0.5); } }
    </style>
</head>
<body>

    <div id="db-panel">
        <div class="db-header"><span>RUIDO AMBIENTE</span><span id="status-lbl">CR√çTICO</span></div>
        <div id="db-number">0 dB</div>
        <div class="bar-container"><div id="bar-fill"></div></div>
    </div>

    <div id="guide-text">ENFOCA EL MARCADOR DE SEGURIDAD</div>

    <div id="controls">
        <button id="btn-start" class="btn-action">üîä INICIAR SONIDO</button>
        <button id="btn-protect" class="btn-action">üéß PONERSE CASCOS</button>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;" vr-mode-ui="enabled: false">
        
        <a-light type="ambient" intensity="0.7"></a-light>
        <a-light type="directional" position="1 1 2" intensity="1.5"></a-light>

        <a-marker type="pattern" url="pattern-marker.patt" smooth="true">
            <a-entity id="ar-content" visible="false">
                
                <a-entity id="headphones" position="0 0.5 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear">
                    <a-torus color="#111" radius="0.5" radius-tubular="0.05" arc="190" rotation="0 90 0"></a-torus>
                    <a-cylinder color="#f1c40f" height="0.2" radius="0.25" rotation="0 0 90" position="-0.55 -0.1 0"></a-cylinder>
                    <a-cylinder color="#f1c40f" height="0.2" radius="0.25" rotation="0 0 90" position="0.55 -0.1 0"></a-cylinder>
                    <a-text value="PELIGRO" color="red" align="center" position="0 -0.5 0" width="4" rotation="-90 0 0"></a-text>
                </a-entity>

                <a-entity id="msg-final" visible="false" position="0 0.5 0" rotation="-90 0 0">
                    <a-plane color="#000" opacity="0.8" width="3" height="1.5"></a-plane>
                    <a-text value="PROTEGIDO" color="#2ecc71" align="center" width="6" position="0 0 0.1"></a-text>
                </a-entity>

            </a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // CONFIGURACI√ìN
        const audioFile = 'Sonidos_De_Fabrica.wav'; // ASEG√öRATE DE QUE EL NOMBRE SEA EXACTO
        
        // VARIABLES
        let audioCtx, track, gainNode, lowPassFilter;
        let audioElement;
        let isProtected = false;
        let meterInterval;

        // UI ELEMENTS
        const btnStart = document.getElementById('btn-start');
        const btnProtect = document.getElementById('btn-protect');
        const dbPanel = document.getElementById('db-panel');
        const dbNum = document.getElementById('db-number');
        const dbBar = document.getElementById('bar-fill');
        const statusLbl = document.getElementById('status-lbl');
        const marker = document.querySelector('a-marker');
        const arContent = document.getElementById('ar-content');

        // 1. INICIAR (Click necesario)
        btnStart.addEventListener('click', () => {
            // Creamos el elemento de audio HTML5 (M√°s seguro que fetch)
            audioElement = new Audio(audioFile);
            audioElement.crossOrigin = "anonymous";
            audioElement.loop = true;

            // Contexto de Audio Web
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();

            // Conectar el elemento al contexto
            track = audioCtx.createMediaElementSource(audioElement);
            
            // Crear Filtro (Efecto ahogado)
            lowPassFilter = audioCtx.createBiquadFilter();
            lowPassFilter.type = 'lowpass';
            lowPassFilter.frequency.value = 22000; // Abierto (sin efecto)

            // Crear Volumen
            gainNode = audioCtx.createGain();
            gainNode.gain.value = 1.0;

            // Cables: Audio -> Filtro -> Volumen -> Salida
            track.connect(lowPassFilter).connect(gainNode).connect(audioCtx.destination);

            // Intentar reproducir
            audioElement.play().then(() => {
                console.log("Audio reproduciendo...");
                btnStart.style.display = 'none';
                btnProtect.style.display = 'inline-block';
                dbPanel.style.display = 'block';
                document.body.classList.add('danger-zone');
                document.getElementById('guide-text').style.display = 'none';
                simulateDecibels(); // Arrancar animaci√≥n de n√∫meros
            }).catch(e => {
                alert("Error: No se encontr√≥ el archivo 'Sonidos_De_Fabrica.wav'. Revisa el nombre en GitHub.");
                console.error(e);
            });
        });

        // 2. DETECTAR MARCADOR
        marker.addEventListener('markerFound', () => {
            arContent.setAttribute('visible', true);
        });

        // 3. ACTIVAR PROTECCI√ìN
        btnProtect.addEventListener('click', () => {
            if(!audioCtx || isProtected) return;
            isProtected = true;

            // Efecto de Audio (Suave)
            // 1. Cerramos el filtro (de 22000Hz a 400Hz)
            lowPassFilter.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 1);
            // 2. Bajamos volumen (de 1.0 a 0.3)
            gainNode.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime + 1);

            // Cambios Visuales
            btnProtect.style.display = 'none';
            document.body.classList.remove('danger-zone');
            
            // Actualizar panel
            dbPanel.style.borderColor = "#2ecc71"; // Verde
            dbPanel.style.boxShadow = "none";
            dbNum.style.color = "#2ecc71";
            statusLbl.innerText = "SEGURO";
            statusLbl.style.color = "#2ecc71";

            // Cambiar AR
            document.getElementById('headphones').setAttribute('visible', false);
            document.getElementById('msg-final').setAttribute('visible', true);
        });

        // ANIMACI√ìN DE DECIBELIOS (Falsa, solo visual)
        function simulateDecibels() {
            meterInterval = setInterval(() => {
                let val, color, width;

                if(!isProtected) {
                    // Rango Peligroso (90 - 105 dB)
                    val = Math.floor(Math.random() * (105 - 92) + 92);
                    color = "#ff4757";
                    width = (val / 110) * 100;
                } else {
                    // Rango Seguro (65 - 75 dB)
                    val = Math.floor(Math.random() * (75 - 65) + 65);
                    color = "#2ecc71";
                    width = (val / 110) * 100;
                }

                dbNum.innerText = val + " dB";
                dbNum.style.color = color;
                dbBar.style.width = width + "%";
                dbBar.style.backgroundColor = color;
            }, 100);
        }
    </script>
</body>
</html>
